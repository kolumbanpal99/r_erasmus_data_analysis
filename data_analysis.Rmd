---
title: "data_analysis"
author: "Pál Kolumbán"
date: "2025-11-10"
output: html_document
---

# Loading the data and relevant packages

```{r Reading in the data and load necessary packages}
library(tidyverse)
library(ggplot2)
erasmus_raw <- read.csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2022/2022-03-08/erasmus.csv', encoding = "latin1")

```

# Glimpse to variables

```{r Explore the dataset variables}
glimpse(erasmus_raw)
summary(erasmus_raw$activity_mob)
table(erasmus_raw$activity_mob)
```
# Checking the df charachteristics

```{r}
str(erasmus_raw)
summary(erasmus_raw)
```

# Checking and filtering the participants age variable
```{r}
# We can see above that the participant age is from -7148 to 1049, which is for most cases cannot be generalized to the population of the world or even European students, so we will adjust first this variable
# Most of the Erasmus participant age fits into 13-30 age limit in my experience, so lets filter the age for those people first

erasmus_raw <- erasmus_raw %>% 
  mutate(participant_age = as.numeric(participant_age)) %>%
  filter(participant_age >= 13, participant_age <= 30)

summary(erasmus_raw$participant_age)

#Now the mean age looks better too

ggplot(erasmus_raw, aes(x = participant_age)) +
  geom_histogram(binwidth = 1, fill = "steelblue",) +
  labs(
    title = "Distribution of participant age variable",
    x = "Age",
    y = "Count"
  )
# This graph show simply the distribution of age variable and does not count for number of participants, we resolve this below
```

```{r}
ggplot(erasmus_raw, aes(x = participant_age, weight = participants)) +
  geom_histogram(binwidth = 1, boundary = 0, closed = "left", fill = "steelblue", color = "black") +
  labs(
    title = "Distribution of participants by age",
    x = "Age of participants",
    y = "Number of Participants"
  ) +
  theme_minimal()
```
# Checking the total number of participants
```{r}
total_participants <-  sum(erasmus_raw$participants)
```

# Checking the number of participants per project

```{r}
erasmus_raw %>%
  group_by(project_reference) %>%
  summarise(
    total_participants = sum(participants, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = total_participants)) +
  geom_histogram(binwidth = 5, fill = "steelblue") +
  labs(
    title = "Distribution of total number of participants per project",
    x = "Number of participants",
    y = "Number of projects"
  ) +
  theme_minimal()
```


# Checking the age distribution for each project

```{r}
project_age <- erasmus_raw %>%
  group_by(project_reference) %>%
  summarise(mean_age = mean(participant_age, na.rm = TRUE))
```

```{r}
ggplot(project_age, aes(x = factor(project_reference), y = mean_age)) +
  geom_col(fill = "steelblue") +
  labs(x = "Project ID", y = "Mean Age", title = "Mean Age per Erasmus Project") +
  theme_minimal()
```

# Checking participants gender variable
```{r}
table(erasmus_raw$participant_gender, useNA = "ifany")
```
# Checking sending and receiving countries
```{r}
table(erasmus_raw$sending_country_code, useNA = "ifany")
table(erasmus_raw$receiving_country_code, useNA = "ifany")
```
# Checking the country codes
# Sending countries
```{r}
erasmus_raw %>%
  select(project_reference, sending_country_code) %>%
  distinct() %>%
  count(sending_country_code) %>%
  ggplot(aes(x = reorder(sending_country_code, n),y = n)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = n), hjust = -0.1, size = 3) +
  coord_flip() +
  labs(
    title = "Number of projects by sending country",
    x = "Sending country",
    y = "Number of projects"
  ) +
  theme_minimal()
```

# Receiving countries
```{r}
erasmus_raw %>%
  select(project_reference, receiving_country_code) %>%
  distinct() %>%
  count(receiving_country_code) %>%
  ggplot(aes(x = reorder(receiving_country_code, n), y = n)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = n), hjust = -0.1, size = 3) +
  coord_flip() +
  labs(
    title = "Number of projects by receiving country",
    x = "Receiving country",
    y = "Number of projects"
  ) +
  theme_minimal()
```


# Checking field of education

```{r}
table(erasmus_raw$field_of_education, useNA = "ifany")
# This variable cannot be considered due to the reading in coding error process
# If we make this read-in process from local file from the project folder it might disappear, otherwise we wont use this variable. Come back to this later on.
```
# Checking participant profile
```{r}
table(erasmus_raw$participant_profile, useNA = "ifany")
# It seems that all of the learners are in age between 13-30 and by filering for age we excluded the leaders/teachers from the dataset.
# To answer our questions about the students the deleted data may be not relevant, so lets continue this way
```

# Checking special needs, fewer opportunities and group leader variables as well
```{r}
table(erasmus_raw$special_needs, useNA = "ifany")
table(erasmus_raw$fewer_opportunities, useNA = "ifany")
table(erasmus_raw$group_leader, useNA = "ifany") # This variable is not relevant this way, as none of the students leads those projects

```

# Dealing with unused data
```{r}
erasmus_raw <- erasmus_raw %>%
  select(-field_of_education, participant_profile, -education_level, -group_leader)
```

# Academic year
```{r}
table(erasmus_raw$academic_year, useNA = "ifany")
```
# Start and end months
```{r}
table(erasmus_raw$mobility_start_month, useNA = "ifany")
table(erasmus_raw$mobility_end_month, useNA = "ifany")
# Maybe it makes sense to split the data for seasons, to check its influence of choosing a destionation country
```

# Creating the season variable 
## Step 1
```{r}
# Getting the 6.th and 7th digits of the cells in the mobility start month variable and saving it as integer to a different variable
erasmus_raw$s_month <- substr(erasmus_raw$mobility_start_month, 6, 7)
erasmus_raw$s_month <- as.integer(erasmus_raw$s_month)

table(erasmus_raw$s_month, useNA = "ifany")
```

## Step 2
```{r}
erasmus_raw$season <- with(erasmus_raw,
  dplyr::case_when(
    s_month %in% c(12, 1, 2) ~ "winter",
    s_month %in% 3:5         ~ "spring",
    s_month %in% 6:8         ~ "summer",
    s_month %in% 9:11        ~ "autumn",
    TRUE                     ~ NA_character_
  )
)
# We created now the season variable which is the season of the start month
```

# Checking the season variable
```{r}
table(erasmus_raw$season, useNA = "ifany")
```

# Check the mobility duration

```{r Mobility duration plots}
summary(erasmus_raw$mobility_duration)
table(erasmus_raw$mobility_duration)

# We can see that majority of the values are from 1 to 10 months
# Lets check with a plot the academic year and duration together
ggplot(erasmus_raw, aes(x = mobility_duration, y = academic_year)) +
  geom_point()
```


```{r}
# The mobility duration numbers are a little bit surprising for me.
# I think that participating in a 20 year lasting erasmus (in case of 273 months) is unusual for most of the students, who generally can go maximum 4 semesters (2 years/24 months) in a row.
```

# Adjustingt mobility duration

```{r}
erasmus_raw <- erasmus_raw %>%
  filter(mobility_duration <= 24)
```

```{r}
boxplot(erasmus_raw$mobility_duration)
# We can see that the duration of mobility variable is right-skewed, having multiple short-term (ex. under 6 months), and less longer-term (between 6 and 20) visits
# If we later include this in models, we have to adjust for this properly
```

```{r}
ggplot(erasmus_raw, aes(x = mobility_duration, y = academic_year)) +
  geom_point()
```

# 1. Analysis question

```{r}
# The Erasmus committee wants to find out what influences most a project popularity, what is indicated via the numbers of the participants within a poject 
```

# First aggregate the data with potentially important factors

```{r}
project_level <- erasmus_raw %>%
  mutate(
    project_year = stringr::str_sub(project_reference, start = 1, end = 4) # first 4 char = year
  ) %>%
  group_by(project_reference, project_year) %>%
  summarise(
    total_participants = sum(participants),
    avg_age = weighted.mean(participant_age, participants, na.rm = TRUE),
    prop_female = sum(participants[participant_gender=="Female"], na.rm = TRUE) / sum(participants),
    prop_fewer_opp = sum(participants[fewer_opportunities=="Yes"], na.rm = TRUE) / sum(participants),
    prop_special = sum(participants[special_needs=="Yes"], na.rm = TRUE) / sum(participants),
    duration = first(mobility_duration),
    season = first(season),
    .groups = 'drop'
  )
```


# 0. Simple analysis question
# Is the project duration affected by the number of participants and average age
```{r}
model_poisson <- glm(total_participants ~ avg_age + duration + prop_female + prop_fewer_opp, 
                     data = project_level, 
                     family = "poisson")

summary(model_poisson, coeff = TRUE)
```

```{r}
library(AER)

# Use the fitted Poisson model
AER::dispersiontest(model_poisson, alternative = "greater")
# Better not to use Poisson
```

# 0.1 Negative binomial regression
# As an alternative we can use negavtive binomial regression
```{r}
library(MASS)
model_negbin <- glm.nb(total_participants ~ avg_age + prop_female + prop_fewer_opp + prop_special + duration, 
                       data = project_level)
summary(model_negbin)
# few variables are not significant, we drop them and check the model again
```

# Selected model 1
# 0.2 Negative binomial regression with less variable
```{r}
library(MASS)
model_negbin_2 <- glm.nb(total_participants ~ avg_age + prop_special + duration,
                       data = project_level)
summary(model_negbin_2)
# better AIC, keep this model
```
# Visualize the model
```{r}
topmodels::rootogram(model_negbin_2)
```

```{r}
library(DHARMa)
res1 <- simulateResiduals(fittedModel = model_negbin_2, n = 1000)
plot(res1)

testDispersion(res1)
testZeroInflation(res1)
testOutliers(res1)
```



# Check interaction too
# Model 0.3.
```{r}
model_negbin_3 <- glm.nb(total_participants ~ avg_age + duration + avg_age * duration, 
                       data = project_level)
summary(model_negbin_3)
```

# Selected model 2
# Model 0.4 Season effect on a project size (popularity)

```{r}
# This is a simple model and it accounts for different season effect on project size
model_negbin_4 <- glm.nb(
  total_participants ~ factor(season),
  data = project_level
)
summary(model_negbin_4)


```
# Visualize the model
```{r}
topmodels::rootogram(model_negbin_4)
```

```{r}
install.packages("DHARMa")
library(DHARMa)
res <- simulateResiduals(fittedModel = model_negbin_4, n = 1000)
plot(res)

testDispersion(res)
utestZeroInflation(res)
testOutliers(res)
```

# Try to log transform the values and check it with ols regression

```{r}
model_log_ols <- lm(log(total_participants) ~ avg_age + prop_special + duration, 
                    data = project_level)

summary(model_log_ols)
```

```{r}
library(DHARMa)
res <- simulateResiduals(fittedModel = model_log_ols, n = 1000)
plot(res)

testDispersion(res)
testZeroInflation(res)
testOutliers(res)
```




