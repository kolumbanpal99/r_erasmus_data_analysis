---
title: "data_analysis"
author: "Pál Kolumbán"
date: "2025-11-10"
output: html_document
---

# Loading the data and relevant packages

```{r Reading in the data and load necessary packages}
library(tidyverse)
library(ggplot2)
erasmus_raw <- read.csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2022/2022-03-08/erasmus.csv', encoding = "latin1")

```

# Glimpse to variables

```{r Explore the dataset variables}
glimpse(erasmus_raw)
summary(erasmus_raw$activity_mob)
table(erasmus_raw$activity_mob)
```
# Checking the df charachteristics

```{r}
str(erasmus_raw)
summary(erasmus_raw)
```

# Participant-s age cleaning
```{r}
# We can see above that the participant age is from -7148 to 1049, which is for most cases cannot be generalized to the population of the world or even European students, so we will adjust first this variable
# Most of the Erasmus participant age fits into 13-30 age limit in my experience, so lets filter the age for those people first

erasmus_raw <- erasmus_raw %>% 
  mutate(participant_age = as.numeric(participant_age)) %>%
  filter(participant_age >= 13, participant_age <= 30)

summary(erasmus_raw$participant_age)

#Now the mean age looks better too

ggplot(erasmus_raw, aes(x = participant_age)) +
  geom_histogram(binwidth = 1) +
  labs(
    title = "Distribution of Participant Age",
    x = "Age",
    y = "Count"
  )
```

# Participant-s gender cleaning
```{r}
table(erasmus_raw$participant_gender, useNA = "ifany")
```
# Sending and receiving country

```{r}
table(erasmus_raw$sending_country_code, useNA = "ifany")
table(erasmus_raw$receiving_country_code, useNA = "ifany")
```

```{r}
# Question to ask:
# What are the most popular destination Countries?
# From where people tend to visit in each country - maybe create groups like: Balkan, etc.
```

# Creating 

```{r}

```

# Checking field of education

```{r}
table(erasmus_raw$field_of_education, useNA = "ifany")
# This variable cannot be considered due to the reading in coding error process
# If we make this read-in process from local file from the project folder it might disappear, otherwise we wont use this variable. Come back to this later on.
```
# Checking participant profile
```{r}
table(erasmus_raw$participant_profile, useNA = "ifany")
# It seems that all of the learners are in age between 13-30 and by filering for age we excluded the leaders/teachers from the dataset.
# To answer our questions about the students the deleted data may be not relevant, so lets continue this way
```
# Checking special needs, fewer opportunities and group leader variables as well

```{r}
table(erasmus_raw$special_needs, useNA = "ifany")
table(erasmus_raw$fewer_opportunities, useNA = "ifany")
table(erasmus_raw$group_leader, useNA = "ifany") # This variable is not relevant this way, as none of the students leads those projects

```
# Academic year

```{r}
table(erasmus_raw$academic_year, useNA = "ifany")

```
# Start and end months

```{r}
table(erasmus_raw$mobility_start_month, useNA = "ifany")
table(erasmus_raw$mobility_end_month, useNA = "ifany")
# Maybe it makes sense to split the data for seasons, to check its influence of choosing a destionation country
```
# Lets have the season variable 
```{r}
# Getting the 6.th and 7th digits of the cells in the mobility start month variable and saving it as integer to a different variable
erasmus_raw$s_month <- substr(erasmus_raw$mobility_start_month, 6, 7)
erasmus_raw$s_month <- as.integer(erasmus_raw$s_month)

table(erasmus_raw$s_month, useNA = "ifany")
```

```{r}
erasmus_raw$season <- with(erasmus_raw,
  dplyr::case_when(
    s_month %in% c(12, 1, 2) ~ "winter",
    s_month %in% 3:5         ~ "spring",
    s_month %in% 6:8         ~ "summer",
    s_month %in% 9:11        ~ "autumn",
    TRUE                     ~ NA_character_
  )
)
# We created now the season variable which is the season of the start month
```

# Checking the season variable

```{r}
table(erasmus_raw$season, useNA = "ifany")
```

# Check the mobility duration

```{r Mobility duration plots}
summary(erasmus_raw$mobility_duration)
table(erasmus_raw$mobility_duration)

# We can see that majority of the values are from 1 to 10 months
# Lets check with a plot the academic year and duration together
ggplot(erasmus_raw, aes(x = mobility_duration, y = academic_year)) +
  geom_point()
```


```{r}
# The mobility duration numbers are a little bit surprising for me.
# I think that participating in a 20 year lasting erasmus (in case of 273 months) is unusual for most of the students, who generally can go maximum 4 semesters (2 years/24 months) in a row.
```

# filtering for reasonable amount of mobility duration

```{r}
erasmus_raw <- erasmus_raw %>%
  filter(mobility_duration <= 24)
```

```{r}
boxplot(erasmus_raw$mobility_duration)
```

```{r}
ggplot(erasmus_raw, aes(x = mobility_duration, y = academic_year)) +
  geom_point()
```


# Check the number of participants

```{r Participant number}
summary(erasmus_raw$participants)
table(erasmus_raw$participants)
sum(erasmus_raw$participants)

ggplot(erasmus_raw, aes(x = participants, y = academic_year)) +
  geom_point()
```

# 1. Analysis question

```{r}
# The Erasmus committee wants to find out what influences most a project popularity, what is indicated via the numbers of the participants within a poject 
```

# First aggregate the data 
```{r}
# group by projects calculate important predictors for each project

project_level <- erasmus_raw %>%
  group_by(project_reference) %>%
  summarise(
    total_participants = sum(participants),
    avg_age = weighted.mean(participant_age, participants, na.rm = TRUE),
    prop_female = sum(participants[participant_gender=="Female"], na.rm = TRUE) / sum(participants),
    prop_fewer_opp = sum(participants[fewer_opportunities=="Yes"], na.rm = TRUE) / sum(participants),
    prop_special = sum(participants[special_needs=="Yes"], na.rm = TRUE) / sum(participants),
    duration = first(mobility_duration),
    season = first(season)
  )
```

# Build a model with the factors we want to include
```{r}
model_project <- glm.nb(total_participants ~ season + duration + avg_age + prop_female + prop_fewer_opp + prop_special, data = project_level)

summary(model_project)

exp(coef(model_project))
```

# Checking model residuals
```{r}
plot(fitted(model_project), resid(model_project))
abline(h=0, col="red")
```

# Duration and project size

```{r}
ggplot(project_level, aes(duration, total_participants)) +
  geom_point(alpha=0.4) +
  geom_smooth(method="loess") +
  scale_y_log10()
```

# Age and project size
```{r}
ggplot(project_level, aes(avg_age, total_participants)) +
  geom_point(alpha=0.4) +
  geom_smooth(method="loess") +
  scale_y_log10()

```


```{r}
ggplot(project_level, aes(season, total_participants)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(y="Project size (log scale)")
```

# Investigating fewer opportunities students 

```{r}
model_fewer <- glm(
  prop_fewer_opp ~ season + duration + avg_age + prop_female + prop_special + total_participants, data = project_level,family = quasibinomial(link = "logit"))
summary(model_fewer)
```

```{r}
ggplot(project_level, aes(prop_special, prop_fewer_opp)) +
  geom_point(alpha=0.4) +
  geom_smooth(method="loess") +
  labs(x="Proportion of special-needs participants", y="Proportion of fewer-opportunity participants")

```

```{r}
cooksd <- cooks.distance(model_project)
plot(cooksd, type="h", main="Cook's distance - Negative Binomial model")
abline(h = 4/length(cooksd), col="red", lty=2) 
```

```{r}
cooksd2 <- cooks.distance(model_fewer)
plot(cooksd2, type="h", main="Cook's distance - Quasi-Binomial model")
abline(h = 4/length(cooksd2), col="red", lty=2)

```








